<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<link rel="stylesheet" type="text/css" href="/css/quill.base.css">
	<script type="text/javascript" src="/js/lib.js"></script>
	<style type="text/css">
	</style>
	<script type="text/javascript">
		const JBILLING = [
			null,
			'Pending',
			'Final Billing',
			'Non Billable',
			'Monthly Billing',
			'Retainer',
			'Progress Billing',
			'Billable'
		]
		const JSTATUS = [
			null,
			'Open',
			'On-Hold',
			'Closed'
		]
		const JTYPE = [
			'Other',
			'Audio',
			'Media',
			'Print',
			'Video',
			'Web'
		]
	</script>
</head>
<body>

<div id="loading"></div>

<ul id="navigation">
	<li><img src="/images/otter-logo.gif"></li>
	<li>
		<a href="#" class="active">my stuff</a>
		<ul>
			<li><a href="#">tasks</a></li>
			<li><a href="#time">time card</a></li>
			<li><a href="#time/add">add time</a></li>
		</ul>
	</li>
	<li>
		<a href="#jobs">jobs</a>
		<ul>
			<li><a href="#add-job">add job</a></li>
			<li><a href="#jobs/1">open jobs</a></li>
			<li><a href="#jobs/3">closed jobs</a></li>
			<li><a href="#jobs/2">on-hold jobs</a></li>
		</ul>
	</li>
	<li>
		<a href="#team">team</a>
		<ul>
			<li><a href="#tasks/team">team tasks</a></li>
			<li><a href="#tasks/unassigned">unassigned tasks</a></li>
		</ul>
	</li>
	<li><a href="#blog">blog</a></li>
	<li><a href="#reports">reports</a></li>
	<li><a href="#clients">clients</a></li>
	<li><a href="#vendors">vendors</a></li>
	<li><a href="#credentials">credentials</a></li>
	<li><a id="login-out" href="#login-out"></a></li>
</ul>

<div id="otter">

	<div id="index"></div>

	<div id="clients"></div>

	<div id="vendors"></div>

	<div id="jobs">
		<div id="page-nav">
			<ul>
				<li data-link="0" class="job-search">All</li>
				<li data-link="1" class="job-search">Open</li>
				<li data-link="3" class="job-search">Closed</li>
				<li data-link="2" class="job-search">On-Hold</li>
			</ul>
			<ul>
				<li><a href="#add-job">Add Job</a></li>
			</ul>
		</div>
		<div id="job-search">
			<select id="search_type">
				<option>All</option>
				<option selected>Job &num;</option>
				<option>Title</option>
			</select><input type="text" id="search_string"><button id="job_search">Search</button>
		</div>
	</div>

	<div id="job">
		<h1><span id="client-and-number"></span> <span id="job-title"></span></h1>
		<h2><span class="h2span">Job Status</span> <span id="job-status"></span> <span class="h2span">Type</span> <span id="job-type"></span></h2>
		<div id="job-link">
			<ul>
				<li>Overview</li>
				<li>Tasks</li>
				<li>Art</li>
				<li>Invoices</li>
			</ul>
			<ul>
				<li>Edit Project</li>
				<li>Create Task</li>
				<li>Add Time</li>
				<li>Add Expense</li>
				<li>Add Estimate</li>
				<li>Add Invoice</li>
				<li>Add Art</li>
			</ul>
		</div>
		<div id="job-details">
			<div id="name-vendor-contact" class="job-details-top">
				<p id="job-creator"><em class="no-hide">Creator </em></p>
				<p id="job-vendor"><em class="no-hide">Vendor </em></p>
				<p id="job-contact"><em class="no-hide">Contact </em></p>
			</div>
			<div id="billing-created-closed" class="job-details-top">
				<p id="job-billing"><em class="no-hide">Billing Status </em></p>
				<p id="job-created"><em class="no-hide">Created </em></p>
				<p id="job-closed"><em class="no-hide">Closed </em></p>
			</div>
			<div id="description"><em>Description</em><p id="job-description"></p></div>
		</div>
		<table class="default-table">
			<thead>
				<tr>
					<th>id</th><th>Estimate Title</th><th>Date</th><th>Added By</th><th>Gross Cost</th><th>Net Cost</th>
				</tr>
			</thead>
			<tbody id="estimate-body"></tbody>
		</table>
		<table class="default-table">
			<thead>
				<tr>
					<th>id</th><th>Time Code</th><th>Total Time</th><th>Total Cost</th>
				</tr>
			</thead>
			<tbody id="times-body"></tbody>
		</table>
		<table class="default-table">
			<thead>
				<tr>
					<th>id</th><th>Expense Title</th><th>Date</th><th>Added By</th><th>Cost</th><th>Final Cost</th>
				</tr>
			</thead>
			<tbody id="expenses-body"></tbody>
		</table>
		<table class="default-table">
			<thead>
				<tr>
					<th>id</th><th>Invoice Title</th><th>Date</th><th>Added By</th><th>Total Cost</th>
				</tr>
			</thead>
			<tbody id="invoices-body"></tbody>
		</table>
		<table class="default-table">
			<thead>
				<tr>
					<th>id</th><th>Art Title</th><th>Date</th><th>Added By</th>
				</tr>
			</thead>
			<tbody id="art-body"></tbody>
		</table>
	</div>

	<div id="credentials">
		<table class="default-table">
			<thead>
				<tr>
					<th>id</th><th>Site</th><th>Username</th><th>Password</th><th>Notes</th>
				</tr>
			</thead>
			<tbody id="credentials-body"></tbody>
		</table>
	</div>

	<div id="add-job">
		<input type="hidden" id="form-name" value="add-job" class="add-job-form" data-type="form">
		<select id="add-job-client-list" data-type="client" class="add-job-form">
			<option value="0">[Select Client]</option>
		</select>
		<input type="text" class="add-job-form" data-type="title">
		<select class="add-job-form" id="add-job-type-list" data-type="type">
			<option value="0">[Job Type]</option>
		</select>
		<div id="content-container">
			<div id="editor-wrapper">
			<div id="formatting-container">
				<select title="Font" class="ql-font">
					<option value="sans-serif" selected>Sans Serif</option>
					<option value="Georgia, serif">Serif</option>
					<option value="Monaco, 'Courier New', monospace">Monospace</option>
				</select>
				<select title="Size" class="ql-size">
					<option value="10px">Small</option>
					<option value="13px" selected>Normal</option>
					<option value="18px">Large</option>
					<option value="32px">Huge</option>
				</select>
				<select title="Text Color" class="ql-color">
					<option value="rgb(255, 255, 255)">White</option>
					<option value="rgb(0, 0, 0)" selected>Black</option>
					<option value="rgb(255, 0, 0)">Red</option>
					<option value="rgb(0, 0, 255)">Blue</option>
					<option value="rgb(0, 255, 0)">Lime</option>
					<option value="rgb(0, 128, 128)">Teal</option>
					<option value="rgb(255, 0, 255)">Magenta</option>
					<option value="rgb(255, 255, 0)">Yellow</option>
				</select>
				<select title="Background Color" class="ql-background">
					<option value="rgb(255, 255, 255)" selected>White</option>
					<option value="rgb(0, 0, 0)">Black</option>
					<option value="rgb(255, 0, 0)">Red</option>
					<option value="rgb(0, 0, 255)">Blue</option>
					<option value="rgb(0, 255, 0)">Lime</option>
					<option value="rgb(0, 128, 128)">Teal</option>
					<option value="rgb(255, 0, 255)">Magenta</option>
					<option value="rgb(255, 255, 0)">Yellow</option>
				</select>
				<select title="Text Alignment" class="ql-align">
					<option value="left" selected>Left</option>
					<option value="center">Center</option>
					<option value="right">Right</option>
					<option value="justify">Justify</option>
				</select>
				<button title="Bold" class="ql-format-button ql-bold">Bold</button>
				<button title="Italic" class="ql-format-button ql-italic">Italic</button>
				<button title="Underline" class="ql-format-button ql-underline">Under</button>
				<button title="Strikethrough" class="ql-format-button ql-strike">Strike</button>
				<button title="Link" class="ql-format-button ql-link">Link</button>
				<button title="Image" class="ql-format-button ql-image">Image</button>
				<button title="Bullet" class="ql-format-button ql-bullet">Bullet</button>
				<button title="List" class="ql-format-button ql-list">List</button>
			</div>
			<div id="add-job-editor" data-type="description" class="add-job-form quill-editor"></div>
			</div>
		</div>
		<select id="add-job-billing-list" class="add-job-form" data-type="billing">
			<option value="0">[Billing]</option>
		</select>
		<button>Cancel</button>
		<button id="create-job" class="submit-button" data-form="add-job-form" data-after="job/">Create Job</button>
	</div>

	<div id="add-client"></div>

	<div id="add-vendor"></div>

    <div id="add-client-contact"></div>

	<div id="add-task"></div>

	<div id="show-task"></div>

	<div id="reports">
		
		<ul>
			<li class="report-button" data-id="adminTimeSheet">Admin Timesheets</li>
			<li class="report-button" data-id="timesForProject">Times for Project</li>
			<li class="report-button" data-id="jobsSinceLastReport">Jobs Since Last Report</li>
			<li class="report-button" data-id="employeeTimesheet">Employee Times</li>
			<li class="report-button" data-id="openJobs-Tasks">Open Jobs &amp; Tasks</li>
			<li class="report-button" data-id="time-CostForClient">Time &amp; Cost for Client</li>
		</ul>

		<div class="report-area" id="adminTimeSheet">
			<h2>Admin Timesheets</h2>
			<input type="text" id="ats_start"><span class="calendar-button" data-target="ats_start">ðŸ“…</span>
			<input type="text" id="ats_end"><span class="calendar-button" data-target="ats_end">ðŸ“…</span>
			<button>Run Report</button>
		</div>

		<div class="report-area" id="timesForProject">
			<h2>Times for Project</h2>
			<select id="project_list"></select>
		</div>

		<div class="report-area" id="jobsSinceLastReport"><h2>Jobs Since Last Report</h2></div>

		<div class="report-area" id="employeeTimesheet"><h2>Employee Times</h2></div>

		<div class="report-area" id="openJobs-Tasks"><h2>Open Jobs &amp; Tasks</h2></div>

		<div class="report-area" id="time-CostForClient"><h2>Time &amp; Cost for Client</h2></div>


	</div>

	<div id="login">
		<input type="hidden" value="login" class="login-form" data-type="form">
		<input name="username" type="text" class="login-form" data-type="username">
		<input name="password" type="password" class="login-form" data-type="password">
		<button class="submit-button" data-form="login-form" data-after="home">Login</button>
	</div>

</div>
<div id="cal-root">
	<h2 id="cal-month"></h2>
	<h2 id="cal-year"></h2>
	<table>
		<thead>
			<tr>
				<th>Sun</th><th>Mon</th><th>Tues</th><th>Weds</th><th>Thurs</th><th>Fri</th><th>Sat</th>
			</tr>
		</thead>
		<tbody id="cal-body">
		</tbody>
	</table>
	<span id="cal-prev-month">&lt;</span><span id="cal-next-month">&gt;</span>
</div>
<script type="text/javascript" src="/js/cal.js"></script>
<script type="text/javascript" src="/js/quill.min.js"></script>
<script type="text/javascript">
	window.auth = false;
	function checkAuth(){
		xhr('/api/auth.php?call=check-auth', function(res){
			console.log(res);
			if (res == true)
				window.auth = true;
			else{
				window.auth = false;
				window.location.hash = "login-out";
			}
		});
	}
	var submitButtons = document.getElementsByClassName('submit-button');
	for(var i=0;i<submitButtons.length;i++){
		submitButtons[i].addEventListener('click', submitForm);
	}
	checkAuth();
	var editors = [];
	editors['add-job-editor'] = new Quill('#add-job-editor', {
		modules: {
			'toolbar': { container: '#formatting-container' },
			'link-tooltip': true,
			'image-tooltip': true
		}
	});

	addEventToAllOfClass(document.getElementsByClassName('calendar-button'), 'click', calPopup);
	window.hash = window.location.hash.substring(1).split('/')[0];
	addEventToAllOfClass(document.getElementsByClassName('job-search'), 'click', function(e){
		window.location.hash = window.hash + "/" + e.target.dataset.link;
		showJobs();
	});
	addEventToAllOfClass(document.getElementsByClassName('report-button'), 'click', selectReport);
	document.getElementById('job_search').addEventListener('click', search);
	document.getElementById('search_string').addEventListener('keypress', search);

	function search(e){
		if((e.type == 'keypress' && e.keyCode == '13') || e.type=="click")
			showJobs(1, document.getElementById('search_string').value, document.getElementById('search_type').value);
	}

	var routes = [];
	routes[''] = index;
	routes['clients'] = getClients;
	routes['vendors'] = getVendors;
	routes['jobs'] = showJobs;
	routes['job'] = showJob;
	routes['credentials'] = showCredentials;
	routes['reports'] = showReports;
	routes['add-job'] = function(){
		showRoute('add-job');
		listClients(document.getElementById('add-job-client-list'));
		selectFromConst(JTYPE, document.getElementById('add-job-type-list'));
		selectFromConst(JBILLING, document.getElementById('add-job-billing-list'));
	}
	routes['add-client'] = function(){showRoute('add-client')};
	routes['add-vendor'] = function(){showRoute('add-vendor')};
	routes['add-client-contact'] = function(){showRoute('add-client-contact')};
	routes['add-task'] = function(){showRoute('add-task')};
	routes['show-task'] = function(){showRoute('show-task')};
	routes['login-out'] = function(){
		if (!window.auth){
			showRoute('login');
		}else{
			xhr('/api/auth.php?call=logout', function(res){
				if (res==true){
					window.auth = false;
					showRoute('login');
				}
			})
		}
	};

	router(routes, window.hash);

	function resetForm(form){
		var elements = document.getElementsByClassName(form),
			node = "";
		for(var i=0; i<elements.length; i++){
			node = elements[i].nodeName;
			switch (node){
				case 'DIV':
					emptyElement(elements[i].firstChild);
					break;
				case 'SELECT':
					elements[i].value=0;
					break;
				case 'INPUT':
					if (elements[i].type=="text" || elements[i].type == "password")
						elements[i].value = '';
					break;
				default:
					break;
			}
		}
		//window.history.back();
	}

	function submitForm(e){
		var form = e.target.dataset.form;
		var elements = document.getElementsByClassName(form),
			node = "",
			data=new FormData();
		for(var i=0; i<elements.length; i++){
			node = elements[i].nodeName;
			switch (node){
				case 'DIV':
					data.append(elements[i].dataset.type, editors[elements[i].id].getHTML());
					break;
				case 'SELECT':
				case 'INPUT':
					data.append(elements[i].dataset.type, elements[i].value);
					break;
				default:
					break;
			}
		}
		//data.append('form', form);
		if (form == 'login-form'){
			xhr('/api/auth.php?call=login', function(res){
				resetForm(form);
				window.auth = res;
				if(window.auth == true)
					window.location.hash = '';
			}, 'post', data);
		}else{
			xhr('/api/php-api.php?call=submit-form', function(res){
				resetForm(form);
				var location = e.target.dataset.after;
				if (res !== true || res !== false)
					location+=res
				window.location.hash=location;
			}, 'post', data);
		}
	}

	function listClients(target){
		xhr('/api/php-api.php?call=list-client', function(res){
			var option;
			for (var i=0; i<res.length; i++){
				option = document.createElement('option');
				option.appendChild(document.createTextNode(res[i].abbr+" - "+res[i].name));
				option.value = res[i].id;
				target.appendChild(option);
			}
		});
	}
	function selectFromConst(src, target){
		var option;
		for(var i=1; i<src.length; i++){
			option = document.createElement('option');
			option.appendChild(document.createTextNode(src[i]));
			option.value = i;
			target.appendChild(option);
		}
	}

	function showReports(){
		showRoute('reports');
		document.getElementById('loading').style.display = "none";
	}

	function selectReport(e){
		hideAllOfClass(document.getElementsByClassName('report-area'));
		document.getElementById(e.target.dataset.id).style.display = "block";
	}

	function showCredentials(){
		showRoute('credentials');
		xhr('/api/php-api.php?call=credentials', function(response){
			createJobInfoTable(response, document.getElementById('credentials-body'), ['id', 'site', 'username', 'password', 'notes']);
			console.log(response);
		});
	}

	function showJob(){
		showRoute('job');
		var job_number = window.location.hash.substring(1).split('/')[1].match(/[0-9A-Za-z]{3}?([0-9]{5,6})/)[1];
		xhr('/api/php-api.php?call=job&number='+job_number, function(response){
			emptyElement([document.getElementById('client-and-number'),
						  document.getElementById('job-title'),
						  document.getElementById('job-status'),
						  document.getElementById('job-type'),
						  document.getElementById('job-creator'),
						  //document.getElementById('job-vendor'),
						  document.getElementById('job-contact'),
						  document.getElementById('job-billing'),
						  document.getElementById('job-created'),
						  document.getElementById('job-closed')]);
			document.getElementById('client-and-number').appendChild(document.createTextNode(response[0].name+" - "+response[0].abbr+response[0].number+" | "));
			document.getElementById('job-title').appendChild(document.createTextNode(response[0].title));
			document.getElementById('job-status').appendChild(document.createTextNode(JSTATUS[response[0].job_status]));
			document.getElementById('job-type').appendChild(document.createTextNode(JTYPE[response[0].type]));
			document.getElementById('job-creator').appendChild(document.createTextNode(response[0].creator));
			//document.getElementById('job-vendor').appendChild(document.createTextNode(response[0].vendor));
			document.getElementById('job-contact').appendChild(document.createTextNode(response[0].contact));
			document.getElementById('job-billing').appendChild(document.createTextNode(JBILLING[response[0].billing_status]));
			document.getElementById('job-created').appendChild(document.createTextNode(response[0].opened));
			document.getElementById('job-closed').appendChild(document.createTextNode(response[0].closed));
			document.getElementById('job-description').innerHTML = response[0].description;
		});
		xhr('/api/php-api.php?call=job-additional&number='+job_number, function(response){
			//console.log(response.timecodes[response.times[0].code]*response.times[0].totaltime);
			createJobInfoTable(response.times, document.getElementById('times-body'), ['id', 'code', 'totaltime', response.timecodes]);
			createJobInfoTable(response.estimates, document.getElementById('estimate-body'), ['id', 'title', 'date', 'added_by', 'amount', 'net']);
			createJobInfoTable(response.expenses, document.getElementById('expenses-body'), ['id', 'title', 'date', 'added_by', 'cost', 'final_cost']);
			createJobInfoTable(response.invoices, document.getElementById('invoices-body'), ['id', 'title', 'date', 'added_by', 'amount']);
			createJobInfoTable(response.art, document.getElementById('art-body'), ['id', 'title', 'date', 'added_by']);
			console.log(response);
		})
	}

	function createJobInfoTable(source, dest, cols){
		var tr, td, a, totals=0;
		for(var i=0; i<source.length; i++){
			tr=document.createElement('tr');
			for(col in cols){
				td = document.createElement('td');
				if(typeof cols[col] != "object"){
					if (cols[col] == 'title' && source[i]['file']){
						a = document.createElement('a');
						a.href = "/upload/"+source[i]['file'];
						console.log(source[i].title == "");
						if(source[i].title != "")
							a.appendChild(document.createTextNode(source[i][cols[col]]));
						else
							a.appendChild(document.createTextNode(source[i]['file']));
						td.appendChild(a);
					}else{
						td.appendChild(document.createTextNode(source[i][cols[col]]));
					}
				}else{
					totals+=cols[col][source[i]['code']]*source[i]['totaltime'];
					td.appendChild(document.createTextNode(cols[col][source[i]['code']]*source[i]['totaltime']));
				}
				if(cols[col] == 'final_cost'){
					totals += parseFloat(source[i][cols[col]]);
				}
				tr.appendChild(td);
			}
			dest.appendChild(tr);
		}
		if(totals != 0){
			tr = document.createElement('tr');
			tr.appendChild(document.createElement('td'));
			td = document.createElement('td');
			tr.appendChild(td);
			console.log(source[0]);
			td.colSpan = cols.length -2;
			td.appendChild(document.createTextNode("total:"));
			td = document.createElement('td');
			tr.appendChild(td);
			td.appendChild(document.createTextNode(totals.toFixed(2)));
			dest.appendChild(tr);
		}
	}

	function router(routes, route){
		try{
			routes[route]();
			document.body.scrollTop = 0;
		}catch(e){
			var hash;
			try{
				if (route.match(/^[A-Za-z]{3}?([0-9]{5,6})$/)[1]){
					window.location.hash = '#job/'+route;
					console.log(hash);
				}
			}catch(e){
				index();
			}
		}
	}
	setInterval(function(){
		if (window.hash != window.location.hash.substring(1).split('/')[0]){
			window.hash = window.location.hash.substring(1).split('/')[0];
			router(routes, window.hash);
		}
		var loginLink = document.getElementById('login-out');
		if(window.auth == true){
			if(loginLink.innerHTML != 'logout')
				loginLink.innerHTML = "logout";
		}else{
			if(loginLink.innerHTML != 'login')
				loginLink.innerHTML = "login";
		}

	}, 250);

	function index(){
		showRoute('index');
		document.getElementById('loading').style.display = "none";
	}

	function showRoute(route){
		var routes = document.querySelectorAll('#otter > div');
		for(var i=0; i<routes.length; i++){
			if (routes[i].id == route){
				routes[i].style.display = "block";
				continue;
			}
			routes[i].style.display = "none";
		}
	}
	function jobClick(e){
		var node = e.target;
		while(node.nodeName != 'LI'){
			node = node.parentNode;
			console.log(node);
		}
		var job_number = node.dataset.job_number;
		window.location.hash = "#job/"+job_number;
	}
	function showJobs(page, search_string, search_type){
		if (!page)
			page = 1;
		if (!search_string)
			search_string = '';
		if (!search_type)
			search_type = 'all';
		showRoute('jobs');
		var status = window.location.hash.substring(1).split('/')[1] || "0";
		xhr('/api/php-api.php?call=job-search&page='+page+'&status='+status+'&search_string='+search_string+'&search_type='+search_type, function(response){
			if (!response)
				return;
			try{
				var oldul = document.getElementById('search-results');
				oldul.parentNode.removeChild(oldul);
				var oldpl = document.getElementById('page_links');
				oldpl.parentNode.removeChild(oldpl);
			}catch(e){
				//
			}
			var jobs = response[1];
			var ul = document.createElement('ul'), page_links = document.createElement('p');
			page_links.id = "page_links";
			ul.id = "search-results";
			var li, bstatus, number_title, jstatus_creator;
			for(var i=0; i<jobs.length; i++){
				li = document.createElement('li');
				bstatus = document.createElement('span');
				number_title = document.createElement('h2');
				jstatus_creator = document.createElement('h3');
				li.appendChild(bstatus);
				li.appendChild(number_title);
				li.appendChild(jstatus_creator);
				ul.appendChild(li);
				li.addEventListener('click', jobClick);
				bstatus.innerHTML = JBILLING[jobs[i].billing_status];
				number_title.innerHTML = "<em>"+jobs[i].abbr+jobs[i].number+"</em> | "+jobs[i].title;
				jstatus_creator.innerHTML = "<em>Job Status</em> "+JSTATUS[jobs[i].job_status]+" <em>Creator</em> "+jobs[i].first+" "+jobs[i].last;
				li.dataset.job_number = jobs[i].abbr+jobs[i].number;
			}
			document.getElementById('jobs').appendChild(ul);
			document.getElementById('jobs').appendChild(page_links);
			var page_count = Math.ceil(response[0]/50);
			var a, start = page-5, end = parseInt(page)+5;
			if(start < 1)
				start = 1;
			if(end > page_count)
				end = page_count;
			if(start != 1){
				a = document.createElement('a');
				a.dataset.page = 1;
				a.addEventListener('click', function(e){showJobs(e.target.dataset.page, document.getElementById('search_string').value, document.getElementById('search_type').value)});
				a.appendChild(document.createTextNode("\u00ab"));
				a.title = "first page";
				page_links.appendChild(a);
				page_links.appendChild(document.createTextNode(' '));
			}
			for(var i=start; i<=end; i++){
				a=document.createElement('a');
				a.dataset.page = i;
				a.addEventListener('click', function(e){showJobs(e.target.dataset.page, document.getElementById('search_string').value, document.getElementById('search_type').value)});
				a.appendChild(document.createTextNode(i));
				page_links.appendChild(a);
				page_links.appendChild(document.createTextNode(' '));
			}
			if(end != page_count){
				a = document.createElement('a');
				a.dataset.page = page_count;
				a.addEventListener('click', function(e){showJobs(e.target.dataset.page, document.getElementById('search_string').value, document.getElementById('search_type').value)});
				a.appendChild(document.createTextNode("\u00bb"));
				a.title = "last page";
				page_links.appendChild(a);
				page_links.appendChild(document.createTextNode(' '));
			}
		});
	}

	function getClients(){
		xhr('/api/php-api.php?call=list-clients', function(response){
			showRoute('clients');
			var client, list = buildClientVendor(['name', 'abbr'], response);
			removeOldUL('clients');
			document.getElementById('clients').appendChild(list);
			/*if ((client = window.location.hash.substring(1).split('/')[1]) != undefined){
				showClient(client);
			}*/
			try{
				var old = document.getElementById(window.hash+'info');
				old.parentNode.removeChild(old);
			}catch(e){
				//
			}
		});
	}

	function removeOldUL(type){
		var oldul;
		if(oldul = document.querySelectorAll("#"+type+" > ul")){
			for(var i=0; i<oldul.length; i++){
				oldul[i].parentNode.removeChild(oldul[i]);
			}
		}
	}

	function getVendors(){
		xhr('/api/php-api.php?call=list-vendors', function(response){
			showRoute('vendors');
			var vendor, list = buildClientVendor(['name'], response);
			removeOldUL('vendors');
			document.getElementById('vendors').appendChild(list);
			/*if ((vendor = window.location.hash.substring(1).split('/')[1]) != undefined){
				showVendor(vendor);
			}*/
			try{
				var old = document.getElementById(window.hash+'info');
				old.parentNode.removeChild(old);
			}catch(e){
				//
			}
		});
	}

	function showClientVendor(e){
		var row = e.target.row;
		xhr('/api/php-api.php?call=show-contact-vendor&type='+window.hash+'&id='+e.target.dataset.id, function (response) {
			try{
				var old = document.getElementById(window.hash+'info');
				old.parentNode.removeChild(old);
			}catch(e){
				//
			}
			var main_div = document.createElement('div'),
			name = document.createElement('h2'),
			type_abbr = document.createElement('h3'),
			notes = document.createElement('p'),
			address = document.createElement('address'), assemble_addr='';
			main_div.classList.add('client-vendor-information');
			main_div.id = window.hash+"info";
			main_div.appendChild(name);
			main_div.appendChild(type_abbr);
			main_div.appendChild(address);
			main_div.appendChild(notes);
			notes.classList.add('notes');
			document.getElementById(window.hash).appendChild(main_div);
			name.appendChild(document.createTextNode(row.name));
			if (row.type)
				type_abbr.appendChild(document.createTextNode(row.type));
			else
				type_abbr.appendChild(document.createTextNode(row.abbr));
			assemble_addr+=row.address+"<br>";
			if(row.address2 != '')
				assemble_addr+=row.address2+"<br>";
			assemble_addr+=row.city+"<br>"+row.state+"<br>"+row.zip;
			if(row.phone)
				assemble_addr+="<br>"+row.phone;
			address.innerHTML = assemble_addr;
			if(row.notes)
				notes.innerHTML=row.notes;
			var div = document.createElement('div');
			div.classList.add('contact-list');
			var p, contact = "";
			for (var i=0; i<response.length; i++){
				p = document.createElement('p');
				contact += response[i].first+"<br>"+response[i].last+"<br>"+response[i].title+"<br>"+response[i].email+"<br>"+response[i].mobile+"<br>"+response[i].office+"<br>"+response[i].ext;
				p.innerHTML = contact;
				div.appendChild(p);
				contact = "";
			}
			main_div.appendChild(div);
		});
	}

	function buildClientVendor(listKeys, response){
		var ul = document.createElement('ul');
		var li, span;
		for(var i=0; i<response.length; i++){
			li = document.createElement('li');
			li.appendChild(document.createTextNode(response[i][listKeys[0]]));
			li.dataset.id = response[i].id;
			li.row = response[i];
			li.addEventListener('click', showClientVendor);
			if(listKeys[1] != undefined){
				span = document.createElement('span');
				span.appendChild(document.createTextNode(response[i][listKeys[1]]));
				li.appendChild(span);
			}
			ul.appendChild(li);
		}
		return ul;
	}


	//simple xhr abstraction.
	function xhr(url, callback, type, params) {
		document.getElementById('loading').style.display = "block";
		type = type || "get";
		var xhr = new XMLHttpRequest();
		xhr.open(type, url);
		xhr.onreadystatechange = function(){
			if(this.readyState == 4 && this.status == 200){
				callback(JSON.parse(this.responseText));
				document.getElementById('loading').style.display = "none";
			}
		}
		xhr.send(params);
	}
	//empty out an element
	function emptyElement(element){
		if(!element.length)
			element = [element];
		var child, reserve;
		for(list in element){
			reserve = [];
			while (element[list].lastChild){
				try{
					child = element[list].lastChild.classList.contains('no-hide');
					if (child){
						reserve.push(element[list].lastChild);
					}
					element[list].removeChild(element[list].lastChild);
					child = false;
				}catch(e){
					console.log(e)
					element[list].removeChild(element[list].lastChild);
				}
			}
			for (e in reserve)
				element[list].appendChild(reserve[e]);
		}
	}
	function addEventToAllOfClass(collection, event_type, callback){
		for(var i=0; i<collection.length; i++){
			collection[i].addEventListener(event_type, callback);
		}
	}
	function hideAllOfClass(collection){
		for(var i = 0; i<collection.length; i++){
			collection[i].style.display = "none";
		}
	}
</script>
</body>
</html>
