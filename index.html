<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script type="text/javascript" src="/js/lib.js"></script>
	<style type="text/css">
	</style>
	<script type="text/javascript">
		const JBILLING = [
			null,
			'Pending',
			'Final Billing',
			'Non Billable',
			'Monthly Billing',
			'Retainer',
			'Progress Billing',
			'Billable'
		]
		const JSTATUS = [
			null,
			'Open',
			'On-Hold',
			'Closed'
		]
		const JTYPE = [
			null,
			'Audio',
			'Media',
			'Print',
			'Video',
			'Web',
			'Other'
		]
	</script>
</head>
<body>

<ul id="navigation">
	<li><img src="/images/otter-logo.gif"></li>
	<li>
		<a href="#" class="active">my stuff</a>
		<ul>
			<li><a href="#">tasks</a></li>
			<li><a href="#time">time card</a></li>
			<li><a href="#time/add">add time</a></li>
		</ul>
	</li>
	<li>
		<a href="#jobs">jobs</a>
		<ul>
			<li><a href="#jobs/add">add job</a></li>
			<li><a href="#jobs/open">open jobs</a></li>
			<li><a href="#jobs/closed">closed jobs</a></li>
			<li><a href="#jobs/onhold">on-hold jobs</a></li>
		</ul>
	</li>
	<li>
		<a href="#team">team</a>
		<ul>
			<li><a href="#tasks/team">team tasks</a></li>
			<li><a href="#tasks/unassigned">unassigned tasks</a></li>
		</ul>
	</li>
	<li><a href="#blog">blog</a></li>
	<li><a href="#reports">reports</a></li>
	<li><a href="#clients">clients</a></li>
	<li><a href="#vendors">vendors</a></li>
	<li><a href="#credentials">credentials</a></li>
	<li><a href="#logout">logout</a></li>
</ul>

<div id="otter">

	<div id="index"></div>

	<div id="clients">
		
	</div>

	<div id="vendors">

	</div>

	<div id="jobs">
		<div id="page-nav">
			<ul>
				<li>All</li>
				<li>Open</li>
				<li>Closed</li>
				<li>On-Hold</li>
			</ul>
			<ul>
				<li>Add Job</li>
			</ul>
		</div>
		<div id="job-search">
			<select>
				<option>All</option>
				<option>Job &num;</option>
				<option>Title</option>
			</select><input type="text"><button>Search</button>
		</div>
	</div>

</div>

<script type="text/javascript">
	window.hash = window.location.hash.substring(1).split('/')[0];

	var routes = [];
	routes[''] = index;
	routes['clients'] = getClients;
	routes['vendors'] = getVendors;
	routes['jobs'] = showJobs;

	router(routes, window.hash);

	function router(routes, route){
		routes[route]();
	}
	setInterval(function(){
		if (window.hash != window.location.hash.substring(1).split('/')[0]){
			window.hash = window.location.hash.substring(1).split('/')[0];
			router(routes, window.hash);
		}
	}, 250);

	function index(){
		showRoute('index');
	}

	function showJobs(){
		showRoute('jobs');
		xhr('/api/php-api.php?call=job-search', function(response){
			try{
				var oldul = document.getElementById('search-results');
				oldul.parentNode.removeChild(oldul);
			}catch(e){
				//
			}
			console.log(response.length);
			console.log(response);
			var ul = document.createElement('ul');
			ul.id = "search-results";
			var li, bstatus, number_title, jstatus_creator;
			for(var i=0; i<response.length; i++){
				li = document.createElement('li');
				bstatus = document.createElement('span');
				number_title = document.createElement('h2');
				jstatus_creator = document.createElement('h3');
				li.appendChild(bstatus);
				li.appendChild(number_title);
				li.appendChild(jstatus_creator);
				ul.appendChild(li);
				bstatus.innerHTML = JBILLING[response[i].billing_status];
				number_title.innerHTML = "<em>"+response[i].abbr+response[i].number+"</em> | "+response[i].title;
				jstatus_creator.innerHTML = "<em>Job Status</em> "+JSTATUS[response[i].job_status]+" <em>Creator</em> "+response[i].first+" "+response[i].last;
			}
			document.getElementById('jobs').appendChild(ul);
		});
	}

	function getClients(){
		xhr('/api/php-api.php?call=list-clients', function(response){
			showRoute('clients');
			var client, list = buildClientVendor(['name', 'abbr'], response);
			removeOldUL('clients');
			document.getElementById('clients').appendChild(list);
			/*if ((client = window.location.hash.substring(1).split('/')[1]) != undefined){
				showClient(client);
			}*/
		});
	}

	function removeOldUL(type){
		var oldul;
		if(oldul = document.querySelectorAll("#"+type+" > ul")){
			for(var i=0; i<oldul.length; i++){
				oldul[i].parentNode.removeChild(oldul[i]);
			}
		}
	}

	function getVendors(){
		xhr('/api/php-api.php?call=list-vendors', function(response){
			showRoute('vendors');
			var vendor, list = buildClientVendor(['name'], response);
			removeOldUL('vendors');
			document.getElementById('vendors').appendChild(list);
			/*if ((vendor = window.location.hash.substring(1).split('/')[1]) != undefined){
				showVendor(vendor);
			}*/
		});
	}

	function showClientVendor(e){
		var row = e.target.row;
		xhr('/api/php-api.php?call=show-contact-vendor&type='+window.hash+'&id='+e.target.dataset.id, function (response) {
			try{
				var old = document.getElementById(window.hash+'info');
				old.parentNode.removeChild(old);
			}catch(e){
				//
			}
			var main_div = document.createElement('div'),
			name = document.createElement('h2'),
			type_abbr = document.createElement('h3'),
			notes = document.createElement('p'),
			address = document.createElement('address'), assemble_addr='';
			main_div.classList.add('client-vendor-information');
			main_div.id = window.hash+"info";
			main_div.appendChild(name);
			main_div.appendChild(type_abbr);
			main_div.appendChild(address);
			main_div.appendChild(notes);
			notes.classList.add('notes');
			document.getElementById(window.hash).appendChild(main_div);
			name.appendChild(document.createTextNode(row.name));
			if (row.type)
				type_abbr.appendChild(document.createTextNode(row.type));
			else
				type_abbr.appendChild(document.createTextNode(row.abbr));
			assemble_addr+=row.address+"<br>";
			if(row.address2 != '')
				assemble_addr+=row.address2+"<br>";
			assemble_addr+=row.city+"<br>"+row.state+"<br>"+row.zip;
			if(row.phone)
				assemble_addr+="<br>"+row.phone;
			address.innerHTML = assemble_addr;
			if(row.notes)
				notes.innerHTML=row.notes;
			var div = document.createElement('div');
			div.classList.add('contact-list');
			var p, contact = "";
			for (var i=0; i<response.length; i++){
				p = document.createElement('p');
				contact += response[i].first+"<br>"+response[i].last+"<br>"+response[i].title+"<br>"+response[i].email+"<br>"+response[i].mobile+"<br>"+response[i].office+"<br>"+response[i].ext;
				p.innerHTML = contact;
				div.appendChild(p);
				contact = "";
			}
			main_div.appendChild(div);
		});
	}

	function buildClientVendor(listKeys, response){
		var ul = document.createElement('ul');
		var li, span;
		for(var i=0; i<response.length; i++){
			li = document.createElement('li');
			li.appendChild(document.createTextNode(response[i][listKeys[0]]));
			li.dataset.id = response[i].id;
			li.row = response[i];
			li.addEventListener('click', showClientVendor);
			if(listKeys[1] != undefined){
				span = document.createElement('span');
				span.appendChild(document.createTextNode(response[i][listKeys[1]]));
				li.appendChild(span);
			}
			ul.appendChild(li);
		}
		return ul;
	}

	function showRoute(route){
		var routes = document.querySelectorAll('#otter > div');
		for(var i=0; i<routes.length; i++){
			if (routes[i].id == route){
				routes[i].style.display = "block";
				continue;
			}
			routes[i].style.display = "none";
		}
	}

	//simple xhr abstraction.
	function xhr(url, callback, type, params) {
		type = type || "get";
		var xhr = new XMLHttpRequest();
		xhr.open(type, url);
		xhr.onreadystatechange = function(){
			if(this.readyState == 4 && this.status == 200){
				callback(JSON.parse(this.responseText));
			}
		}
		xhr.send(params);
	}
	//empty out an element
	function emptyElement(element){
		var child, reserve = [];
		while (element.lastChild){
			try{
				child = element.lastChild.classList.contains('no-hide');
				if (child){
					reserve.push(element.lastChild);
				}
				element.removeChild(element.lastChild);
				child = false;
			}catch(e){
				console.log(e)
				element.removeChild(element.lastChild);
			}
		}
		for (e in reserve)
			element.appendChild(reserve[e]);
	}
</script>
</body>
</html>